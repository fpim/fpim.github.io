<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="python tricks and tips">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>from python import me</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://fpim.github.io/">
<!--[if lt IE 9]>
            <script src="assets/js/html5shiv.min.js"></script>
            <script src="assets/js/respond.min.js"></script>
        <![endif]--><link rel="prefetch" href="posts/setting-up-python-windows-embeddable-environment-properly/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default header-panel shadow-z-3" role="navigation"><div class="container-fluid">
        <div class="row">
          <div class="col-xs-3">
            <h1 class="title-blog">
                <a href="https://fpim.github.io/">
                        <span id="blog-title">from python import me</span>
                    </a>
            </h1>
          </div>
          <div class="col-xs-9">
            <a id="hamburger" class="btn btn-raised" href="javascript:void(0);" onclick="menuToggle();">☰</a>
          </div>
        </div>
      </div>
<!-- /.container-fluid -->
</nav><div class="container-fluid main" id="content" role="main">
        <div class="row">
            <nav class="col-xs-12 col-sm-3 menu"><ul>
<li class="withripple"><a href="archive.html">Archive</a></li>
                <li class="withripple"><a href="categories/">Tags</a></li>
                <li class="withripple"><a href="rss.xml">RSS feed</a></li>

                    
                </ul>
<ul></ul></nav><div class="posts-material col-xs-12 col-sm-9">
                <div class="col-xs-12 col-md-11 content-material">

    <div class="postindex well post-material ">
    
        <article class="h-entry post-text"><header><h1 class="p-name entry-title header"><a href="posts/setting-up-python-windows-embeddable-environment-properly/" class="u-url">Setting up python's Windows embeddable distribution (properly)</a></h1>
            <div class="metadata">
                <span class="byline author vcard">
                        <i class="mdi-action-face-unlock"></i>
                    fyim
                </span>
                <span class="dateline"><a href="posts/setting-up-python-windows-embeddable-environment-properly/" rel="bookmark">
                    <i class="mdi-device-access-time"></i><time class="published dt-published" datetime="2019-09-09T14:48:18+08:00" title="2019-09-09 14:48">2019-09-09 14:48</time></a></span>
                    <span class="commentline">            <a href="posts/setting-up-python-windows-embeddable-environment-properly/#disqus_thread" data-disqus-identifier="cache/posts/setting-up-python-windows-embeddable-environment-properly.html">Comments</a>

</span>
            </div>
            <hr></header><div class="e-content entry-content">
        <div>
<h2>Embeddable distribution</h2>
<p>If there is anything I like about Windows as a pythonist, it must be that 
you can use <a href="https://docs.python.org/3/using/windows.html#windows-embeddable">embedded distribution</a> of python.  </p>
<blockquote>
<p>The embedded distribution is a ZIP file containing a minimal Python environment. 
It is intended for acting as part of another application, rather than being directly 
accessed by end-users.</p>
</blockquote>
<p>In my opinion, it is a portable, ready-to-ship virtualenv. However, the 
embedded distribution comes with some limitation:</p>
<blockquote>
<p>Third-party packages should be installed by the application installer alongside 
the embedded distribution. Using pip to manage dependencies as for a regular Python 
installation is not supported with this distribution, though with some care it may be 
possible to include and use pip for automatic updates. In general, third-party packages 
should be treated as part of the application (“vendoring”) so that the developer can 
ensure compatibility with newer versions before providing updates to users.</p>
</blockquote>
<p>Sounds scary right? It said it doesn't even support pip. Don't worry, follow
these simple steps, you will have a fully workable embedded environment.</p>
<h3>Get the distribution</h3>
<ol>
<li>Go to <a href="https://www.python.org/downloads/windows/">https://www.python.org/downloads/windows/</a>
</li>
<li>Choose the version python you like and download the corresponding <code>Windows x86-64 embeddable zip file</code>.</li>
<li>Unzip the file. </li>
</ol>
<p>To make this tutorial easy to follow, I am assuming that you have downloaded <code>Python3.7</code> and unzipped it to
<code>C:\python\</code>.</p>
<h3>Get pip</h3>
<p>The distribution does not have pip installed in place, you need to install it yourself:
1. Download <code>get-pip.py</code> at <a href="https://bootstrap.pypa.io/get-pip.py">https://bootstrap.pypa.io/get-pip.py</a>
2. Save it to <code>c:\python\get-pip.py</code>
3. In command-line run <code>C:\python\python get-pip.py</code>
4. pip is now installed</p>
<h3>Config path</h3>
<p>The runtime of this distribution doesn't have an empty string <code>''</code> added in <code>sys.path</code>,
so that the <code>current directory</code> is not added into <code>sys.path</code>, to solve the problem,
you need to:</p>
<ol>
<li>Open <code>C:\python\python37._pth</code>.</li>
<li>Uncomment the line <code>#import site</code> and save.</li>
<li>Create a new .py file and save it as <code>c:\python\sitecustomize.py</code>:</li>
</ol>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</pre>


<h3>lib2to3 issue</h3>
<p>You will encounter the following error when you try to install some packages:</p>
<pre class="code literal-block"><span></span><span class="n">error</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">0</span><span class="p">]</span> <span class="n">Error</span><span class="p">:</span> <span class="s1">'lib2to3</span><span class="se">\\</span><span class="s1">Grammar3.6.5.final.0.pickle'</span>
</pre>


<ol>
<li>Unzip <code>C:\python\python37.zip</code> to a <code>new folder</code>
</li>
<li>Delete <code>C:\python\python37.zip</code>
</li>
<li>Rename the <code>new folder</code> to <code>python37.zip</code> (yes, a new folder called <code>python37.zip</code>)</li>
</ol>
<p>Python's import module is able to treat zip file as folder however, it cannot
read pickle file inside a zip file, so unzip it and rename it.</p>
<h3>Running pip</h3>
<p>If you don't want to mess with you PATH, you can simply do the following in your window command prompt:</p>
<ol>
<li><code>CD C:\python\Scripts</code></li>
<li><code>pip install xxxxx</code></li>
</ol>
<h3>Running Scripts</h3>
<p>Again if you don't want to mess with you PATH, you can simply do in your window command prompt:</p>
<ol>
<li><code>C:\python\python &lt;path to your script&gt;</code></li>
</ol>
<h4>Done!</h4>
</div>
        </div>
        </article><article class="h-entry post-text"><header><h1 class="p-name entry-title header"><a href="posts/object-oriented-design-with-pandas/" class="u-url">Object-Oriented Design architecture with Pandas</a></h1>
            <div class="metadata">
                <span class="byline author vcard">
                        <i class="mdi-action-face-unlock"></i>
                    fyim
                </span>
                <span class="dateline"><a href="posts/object-oriented-design-with-pandas/" rel="bookmark">
                    <i class="mdi-device-access-time"></i><time class="published dt-published" datetime="2019-09-06T15:29:14+08:00" title="2019-09-06 15:29">2019-09-06 15:29</time></a></span>
                    <span class="commentline">            <a href="posts/object-oriented-design-with-pandas/#disqus_thread" data-disqus-identifier="cache/posts/domain-driven-design-with-pandas.html">Comments</a>

</span>
            </div>
            <hr></header><div class="e-content entry-content">
        <div>
<p>Hi guys. Today I would like to talk about implementing Object-oriented (OO) Design to build a Business Intelligence module with Python and Pandas. </p>
<p>Pandas is widely used for data analytics, it is easy to use, one can easily build a script of hundreds of lines of codes
using pandas to handle complex data. However, having worked with many data analysts, I found that most of the scripts produced by data analysts should fall into the category of "procedural code", which is not reusable.
Changing the context a bit would often result in a complete re-write of the code. It is fine if you are in the "research" area where your code
are used for "exploration" or "experimental" purposes, but if you are to write code that contributes
to a larger system or code that will be run repeatedly, you need to implement some architecture.</p>
<h3>My Background</h3>
<p>I work in finance where I need to handle data with complex relationship daily.
The raw data that I received is usually too "raw" such that extracting any useful information from it often requires a lot of steps. Code could easily become impossible to maintain due to the mismatch of raw data structure and business logic.</p>
<h5>The solution</h5>
<p>Soon I realized that I needed a OO layer on top of the raw data to handle all the complexity. 
The reason I use the term <strong>OO layer</strong> here is that OO is essentially an abstraction layer. 
<strong>It allows you to focus on business logic only, instead of having to worry about how to implement business from raw data.</strong>
Architecture is all about reducing your cognitive burden when you try to edit a codebase.</p>
<h2>The Data</h2>
<p>We will try to build a OO model for some trade data:</p>
<table>
<thead><tr>
<th>Account,</th>
<th>Stock_Code,</th>
<th>BuySell,</th>
<th>Date,</th>
<th>Quantity,</th>
<th>Unit_Price</th>
</tr></thead>
<tbody>
<tr>
<td>1001</td>
<td>001</td>
<td>B</td>
<td>20190105</td>
<td>8</td>
<td>2</td>
</tr>
<tr>
<td>1001</td>
<td>002</td>
<td>B</td>
<td>20190105</td>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>1001</td>
<td>002</td>
<td>S</td>
<td>20190106</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>1001</td>
<td>003</td>
<td>B</td>
<td>20190106</td>
<td>6</td>
<td>5</td>
</tr>
<tr>
<td>1001</td>
<td>003</td>
<td>S</td>
<td>20190106</td>
<td>4</td>
<td>6</td>
</tr>
<tr>
<td>1001</td>
<td>001</td>
<td>S</td>
<td>20190107</td>
<td>6</td>
<td>3</td>
</tr>
<tr>
<td>1002</td>
<td>001</td>
<td>B</td>
<td>20190105</td>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>1002</td>
<td>002</td>
<td>B</td>
<td>20190105</td>
<td>8</td>
<td>3</td>
</tr>
<tr>
<td>1002</td>
<td>002</td>
<td>S</td>
<td>20190106</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>1002</td>
<td>003</td>
<td>B</td>
<td>20190106</td>
<td>5</td>
<td>5</td>
</tr>
<tr>
<td>1002</td>
<td>003</td>
<td>S</td>
<td>20190106</td>
<td>4</td>
<td>6</td>
</tr>
<tr>
<td>1002</td>
<td>001</td>
<td>S</td>
<td>20190107</td>
<td>6</td>
<td>3</td>
</tr>
</tbody>
</table>
<p><br><br>
some account information:</p>
<table>
<thead><tr>
<th>Account,</th>
<th>Name</th>
</tr></thead>
<tbody>
<tr>
<td>1001</td>
<td>David</td>
</tr>
<tr>
<td>1002</td>
<td>Tom</td>
</tr>
</tbody>
</table>
<p><br><br>
and some closing price data:</p>
<table>
<thead><tr>
<th>Stock_Code,</th>
<th>Closing_Price,</th>
<th>Data</th>
</tr></thead>
<tbody>
<tr>
<td>001</td>
<td>2</td>
<td>20190105</td>
</tr>
<tr>
<td>001</td>
<td>3</td>
<td>20190106</td>
</tr>
<tr>
<td>001</td>
<td>2</td>
<td>20190107</td>
</tr>
<tr>
<td>002</td>
<td>2</td>
<td>20190105</td>
</tr>
<tr>
<td>002</td>
<td>3</td>
<td>20190106</td>
</tr>
<tr>
<td>002</td>
<td>5</td>
<td>20190107</td>
</tr>
<tr>
<td>003</td>
<td>5</td>
<td>20190105</td>
</tr>
<tr>
<td>003</td>
<td>6</td>
<td>20190106</td>
</tr>
<tr>
<td>003</td>
<td>7</td>
<td>20190107</td>
</tr>
</tbody>
</table>
<p>First, we will have a "Data Layer" to handle the i/o of source data. since we don't have the actual data source, we will 
mock it up:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="k">class</span> <span class="nc">Data</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">trade_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This method should handle the import of source data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        Account|Stock_Code|BuySell|Date|Quantity|Unit_Price</span>
<span class="s2">        1001|001|B|20190105|8|2</span>
<span class="s2">        1001|002|B|20190105|4|3</span>
<span class="s2">        1001|002|S|20190106|3|1</span>
<span class="s2">        1001|003|B|20190106|6|5</span>
<span class="s2">        1001|003|S|20190106|4|6</span>
<span class="s2">        1001|001|S|20190107|6|3</span>
<span class="s2">        1002|001|B|20190105|6|2</span>
<span class="s2">        1002|002|B|20190105|8|3</span>
<span class="s2">        1002|002|S|20190106|3|1</span>
<span class="s2">        1002|003|B|20190106|5|5</span>
<span class="s2">        1002|003|S|20190106|4|6</span>
<span class="s2">        1002|001|S|20190107|6|3</span>
<span class="s2">        """</span>

        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">'|'</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">'Account'</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                                <span class="s1">'Date'</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                                <span class="s1">'Stock_Code'</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                                <span class="s2">"Date"</span><span class="p">:</span><span class="nb">str</span><span class="p">})</span>
        <span class="n">df</span><span class="o">.</span><span class="n">Date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s1">'%Y%m</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">account_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        Account|Name</span>
<span class="s2">        1001|David</span>
<span class="s2">        1002|Tom</span>
<span class="s2">        """</span>

        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'|'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">'Account'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                  <span class="s1">'Name'</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">stock_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        Stock_Code|Closing_Price|Date</span>
<span class="s2">        001|2|20190105</span>
<span class="s2">        001|3|20190106</span>
<span class="s2">        001|2|20190107</span>
<span class="s2">        002|2|20190105</span>
<span class="s2">        002|3|20190106</span>
<span class="s2">        002|5|20190107</span>
<span class="s2">        003|5|20190105</span>
<span class="s2">        003|6|20190106</span>
<span class="s2">        003|7|20190107</span>
<span class="s2">        """</span>

        <span class="n">data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'|'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">'Stock_Code'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                  <span class="s1">'Date'</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
        <span class="n">df</span><span class="o">.</span><span class="n">Date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s1">'%Y%m</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
</pre>


<p>The <code>Data</code> object should handle the import and validation of the data only, and it should not implement and business logic.</p>
<p>Then on top of the <code>Data</code> object, we will build our first OO layer:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">Book</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trade_book_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">'_trade_book_df'</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">trade_df</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">account_df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Account'</span><span class="p">),</span><span class="n">on</span><span class="o">=</span><span class="s1">'Account'</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">'Trade_Amount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">Unit_Price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trade_book_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_book_df</span>

    <span class="k">def</span> <span class="nf">stock_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">stock_prices</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Date</span> <span class="o">==</span> <span class="n">date</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holdings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Holdings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">accounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Accounts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">holdings</span><span class="p">)</span>

<span class="n">Book</span><span class="p">()</span><span class="o">.</span><span class="n">trade_book_df</span>

<span class="o">|</span>    <span class="o">|</span>   <span class="n">Account</span> <span class="o">|</span>   <span class="n">Stock_Code</span> <span class="o">|</span> <span class="n">BuySell</span>   <span class="o">|</span> <span class="n">Date</span>                <span class="o">|</span>   <span class="n">Quantity</span> <span class="o">|</span>   <span class="n">Unit_Price</span> <span class="o">|</span> <span class="n">Name</span>   <span class="o">|</span>   <span class="n">Trade_Amount</span> <span class="o">|</span>
<span class="o">|---</span><span class="p">:</span><span class="o">|----------</span><span class="p">:</span><span class="o">|-------------</span><span class="p">:</span><span class="o">|</span><span class="p">:</span><span class="o">----------|</span><span class="p">:</span><span class="o">--------------------|-----------</span><span class="p">:</span><span class="o">|-------------</span><span class="p">:</span><span class="o">|</span><span class="p">:</span><span class="o">-------|---------------</span><span class="p">:</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">0</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">8</span> <span class="o">|</span>            <span class="mi">2</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>             <span class="mi">16</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">4</span> <span class="o">|</span>            <span class="mi">3</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>             <span class="mi">12</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">3</span> <span class="o">|</span>            <span class="mi">1</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>              <span class="mi">3</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">6</span> <span class="o">|</span>            <span class="mi">5</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>             <span class="mi">30</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">4</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">4</span> <span class="o">|</span>            <span class="mi">6</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>             <span class="mi">24</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">5</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">6</span> <span class="o">|</span>            <span class="mi">3</span> <span class="o">|</span> <span class="n">David</span>  <span class="o">|</span>             <span class="mi">18</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">6</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">6</span> <span class="o">|</span>            <span class="mi">2</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>             <span class="mi">12</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">7</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">8</span> <span class="o">|</span>            <span class="mi">3</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>             <span class="mi">24</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">8</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">3</span> <span class="o">|</span>            <span class="mi">1</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>              <span class="mi">3</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">9</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span> <span class="n">B</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">5</span> <span class="o">|</span>            <span class="mi">5</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>             <span class="mi">25</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">10</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">4</span> <span class="o">|</span>            <span class="mi">6</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>             <span class="mi">24</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">11</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span> <span class="n">S</span>         <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>          <span class="mi">6</span> <span class="o">|</span>            <span class="mi">3</span> <span class="o">|</span> <span class="n">Tom</span>    <span class="o">|</span>             <span class="mi">18</span> <span class="o">|</span>
</pre>


<ol>
<li>The <code>Book</code> object has an <code>_data</code> attribute which owns the <code>Data</code> object.</li>
<li>The <code>trade_book_df</code> property implemented two business logic:<ul>
<li>The joining of <code>trade_df</code> and <code>account_df</code>.</li>
<li>The definition of <code>Trade_Amount</code> -&gt; <code>Quantity</code> * <code>Unit_Price</code>.</li>
</ul>
</li>
<li>The <code>stock_prices</code> method extracts stock prices of a specific date.</li>
<li>It provides the gateways to the <code>Holdings</code> and <code>Accounts</code> context which we are going to talk about.</li>
</ol>
<h3>Contexts</h3>
<p>"Context" is the dimension you want to view the data, all the views with the same dimension should be encapsulated 
in one object.</p>
<p>For example, to view the data in the "Holding" context, we need to:
1. aggregate the trade data up to a certain point of time.
2. multiply holding quantity and stock's closing price to obtain the market value.</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">Holdings</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">book</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="o">=</span> <span class="n">book</span>

    <span class="k">def</span> <span class="nf">holdings_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
        <span class="n">trades_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">trade_book_df</span>
        <span class="n">date_hld_df</span> <span class="o">=</span> <span class="n">trades_df</span><span class="p">[</span><span class="n">trades_df</span><span class="o">.</span><span class="n">Date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">]</span>
        <span class="n">date_hld_df</span><span class="p">[</span><span class="s1">'qnt_change'</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_hld_df</span><span class="p">[</span><span class="s1">'BuySell'</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">'B'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">'S'</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span> <span class="o">*</span> <span class="n">date_hld_df</span><span class="o">.</span><span class="n">Quantity</span>
        <span class="n">hld_df</span> <span class="o">=</span> <span class="n">date_hld_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'Account'</span><span class="p">,</span><span class="s1">'Stock_Code'</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">'qnt_change'</span><span class="p">:</span><span class="nb">sum</span><span class="p">})</span>\
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'qnt_change'</span><span class="p">:</span><span class="s1">'Holdings'</span><span class="p">})</span>
        <span class="n">hld_df</span> <span class="o">=</span> <span class="n">hld_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">stock_prices</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Stock_Code'</span><span class="p">),</span><span class="n">on</span><span class="o">=</span><span class="s1">'Stock_Code'</span><span class="p">)</span>
        <span class="n">hld_df</span><span class="p">[</span><span class="s1">'Market_Value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">hld_df</span><span class="o">.</span><span class="n">Closing_Price</span> <span class="o">*</span> <span class="n">hld_df</span><span class="o">.</span><span class="n">Holdings</span>
        <span class="k">return</span> <span class="n">hld_df</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">Book</span><span class="p">()</span><span class="o">.</span><span class="n">holdings</span><span class="o">.</span><span class="n">holdings_of</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="o">|</span>    <span class="o">|</span>   <span class="n">Account</span> <span class="o">|</span>   <span class="n">Stock_Code</span> <span class="o">|</span>   <span class="n">Holdings</span> <span class="o">|</span>   <span class="n">Closing_Price</span> <span class="o">|</span> <span class="n">Date</span>                <span class="o">|</span>   <span class="n">Market_Value</span> <span class="o">|</span>
<span class="o">|---</span><span class="p">:</span><span class="o">|----------</span><span class="p">:</span><span class="o">|-------------</span><span class="p">:</span><span class="o">|-----------</span><span class="p">:</span><span class="o">|----------------</span><span class="p">:</span><span class="o">|</span><span class="p">:</span><span class="o">--------------------|---------------</span><span class="p">:</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">0</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span>          <span class="mi">8</span> <span class="o">|</span>               <span class="mi">3</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>             <span class="mi">24</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span>          <span class="mi">1</span> <span class="o">|</span>               <span class="mi">3</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>              <span class="mi">3</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span>          <span class="mi">2</span> <span class="o">|</span>               <span class="mi">6</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>             <span class="mi">12</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">001</span> <span class="o">|</span>          <span class="mi">6</span> <span class="o">|</span>               <span class="mi">3</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>             <span class="mi">18</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">4</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">002</span> <span class="o">|</span>          <span class="mi">5</span> <span class="o">|</span>               <span class="mi">3</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>             <span class="mi">15</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">5</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>          <span class="mo">003</span> <span class="o">|</span>          <span class="mi">1</span> <span class="o">|</span>               <span class="mi">6</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>              <span class="mi">6</span> <span class="o">|</span>
</pre>


<p>You can then build context on top of context. For example you can have an <code>Accounts</code> context built on top of the 
<code>Holdings</code> context:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">Accounts</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">holdings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_holdings</span> <span class="o">=</span> <span class="n">holdings</span>

    <span class="k">def</span> <span class="nf">account_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_holdings</span><span class="o">.</span><span class="n">holdings_of</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'Account'</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">'Market_Value'</span><span class="p">:</span><span class="nb">sum</span><span class="p">,</span>
                                                         <span class="s1">'Date'</span><span class="p">:</span><span class="s1">'first'</span><span class="p">})</span>

<span class="n">Book</span><span class="p">()</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">account_value</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="o">|</span>    <span class="o">|</span>   <span class="n">Account</span> <span class="o">|</span>   <span class="n">Market_Value</span> <span class="o">|</span> <span class="n">Date</span>                <span class="o">|</span>
<span class="o">|---</span><span class="p">:</span><span class="o">|----------</span><span class="p">:</span><span class="o">|---------------</span><span class="p">:</span><span class="o">|</span><span class="p">:</span><span class="o">--------------------|</span>
<span class="o">|</span>  <span class="mi">0</span> <span class="o">|</span>      <span class="mi">1001</span> <span class="o">|</span>             <span class="mi">39</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span>      <span class="mi">1002</span> <span class="o">|</span>             <span class="mi">39</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">|</span>
</pre>


<h2>Summary</h2>
<p>The above is a simple example of how OO Design can be applied to your pandas script. The architecture allows you to 
scale up easily as the number of data source increase. This has been just a very brief introduction, there are many more 
modeling techniques you can use to manage complex data. Finally, I want to stress that these techniques are becoming more and more important. 
Traditionally, this kind of problem can be handled by the database and relational model, but given the growing complexity and scatteredness of the data, you are
more likely to encounter situations where your database cannot handle everything and you will need some supplement from your code,
especially when you need data from multiple data source.</p>
</div>
        </div>
        </article><article class="h-entry post-text"><header><h1 class="p-name entry-title header"><a href="posts/easy-and-effective-python-type-checker/" class="u-url">Easy (and effective) python type checker</a></h1>
            <div class="metadata">
                <span class="byline author vcard">
                        <i class="mdi-action-face-unlock"></i>
                    fyim
                </span>
                <span class="dateline"><a href="posts/easy-and-effective-python-type-checker/" rel="bookmark">
                    <i class="mdi-device-access-time"></i><time class="published dt-published" datetime="2019-09-01T13:25:58+08:00" title="2019-09-01 13:25">2019-09-01 13:25</time></a></span>
                    <span class="commentline">            <a href="posts/easy-and-effective-python-type-checker/#disqus_thread" data-disqus-identifier="cache/posts/easy-and-effective-python-type-checker.html">Comments</a>

</span>
            </div>
            <hr></header><div class="e-content entry-content">
        <div>
<h2>The Problem</h2>
<p>Types have been implicitly handled by python. Flexible as it may seem, developers often find it causing confusions 
when managing a large project, especially for those coming from a strongly typed language.</p>
<h3>Annotation</h3>
<p>Newer versions of python (3.5+) allow you to put type hints into at function definition. 
However type checking is not supported by python and it is up to python developer to implement 
their own runtime type checking functionality, according to <a href="https://www.python.org/dev/peps/pep-0484/#non-goals">PEP 484</a>:</p>
<blockquote>
<p>While the proposed typing module will contain some building blocks for runtime 
type checking -- in particular the get_type_hints() function -- third party 
packages would have to be developed to implement specific runtime type checking 
functionality, for example using decorators or metaclasses. Using type hints 
for performance optimizations is left as an exercise for the reader.</p>
</blockquote>
<p>Although there are open source libraries like <a href="http://mypy-lang.org/">mypy</a> 
that do type checking for you, this article aims to present you with the minimum knowledge you need to know (and a hack) 
for you to implement your own type checking, if you want to avoid the unnecessary dependencies brought by a full-blown library.</p>
<h4>The Basic Type Hinting</h4>
<p>The following function intends to take two integer as arguments and return the sum of them,
 you can specify the type of the function arguments by adding <code>:type</code> and type of return value by adding <code>-&gt;type</code>:</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># 3</span>
</pre>


<p>However python did next to nothing with the type of value you passed in:</p>
<pre class="code literal-block"><span></span><span class="n">add</span><span class="p">(</span><span class="s1">'nah '</span><span class="p">,</span> <span class="s1">'i dont care'</span><span class="p">)</span>
<span class="c1"># 'nah i dont care'</span>
</pre>


<p>In fact what python did is that it added the type hinting information into the function's 
<code>__annotations__</code> attribute:</p>
<pre class="code literal-block"><span></span><span class="nv">add</span>.<span class="nv">__annotations__</span>
# {<span class="s1">'</span><span class="s">a</span><span class="s1">'</span>: <span class="o">&lt;</span><span class="nv">class</span> <span class="s1">'</span><span class="s">int</span><span class="s1">'</span><span class="o">&gt;</span>, <span class="s1">'</span><span class="s">b</span><span class="s1">'</span>: <span class="o">&lt;</span><span class="nv">class</span> <span class="s1">'</span><span class="s">int</span><span class="s1">'</span><span class="o">&gt;</span>, <span class="s1">'</span><span class="s">return</span><span class="s1">'</span>: <span class="o">&lt;</span><span class="nv">class</span> <span class="s1">'</span><span class="s">int</span><span class="s1">'</span><span class="o">&gt;</span>}
</pre>


<p>Accessing magic function is bad, sometime it doesn't handle edge cases, fortunately the <code>typing</code> module comes with a 
handy function <code>get_type_hints</code> for you to access object's annotations:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">typing</span>
<span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="c1"># {'a': &lt;class 'int'&gt;, 'b': &lt;class 'int'&gt;, 'return': &lt;class 'int'&gt;}</span>
</pre>


<h4>Signature</h4>
<p>To preform type checking, you will need to analyse the functions' signature in runtime. The <code>inspect.signature</code> module 
provides you with a convenient utility (<a href="https://docs.python.org/3/library/inspect.html#inspect.Signature">Signature object</a>) to do so.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="n">sig</span>
<span class="o">&lt;</span><span class="n">Signature</span> <span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="o">&gt;</span>
<span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># &lt;BoundArguments (a=1, b=2)&gt;</span>
<span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># &lt;BoundArguments (a=2, b=2)&gt;</span>
<span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
<span class="c1"># OrderedDict([('a', 2), ('b', 2)])</span>
</pre>


<p>The <code>bind_partial</code> method of the <code>signature</code> object map arguments to their corresponding signature, we can 
use it together with the annotation information to create a simple function decorator that does type checking:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="k">def</span> <span class="nf">type_check</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">wrapped</span>

<span class="nd">@type_check</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># 3</span>

<span class="n">add</span><span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#Traceback (most recent call last):</span>
<span class="c1">#  File "&lt;stdin&gt;", line 1, in &lt;module&gt;</span>
<span class="c1">#  File "/Projects/aw/shit.py", line 37, in wrapped</span>
<span class="c1">#    assert all(isinstance(arguments[k],v) for k,v in annotation.items())</span>
<span class="c1">#AssertionError</span>
</pre>


<p>The above is the most basic type checker you can create, however this type checker involved the use of the <code>inspect</code> module 
which the notoriously slow.</p>
<h4>Let's timeit</h4>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">type_check</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">wrapped</span>

<span class="k">def</span> <span class="nf">useless_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">base_add</span> <span class="o">=</span> <span class="n">useless_wrapper</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="n">tc_add</span> <span class="o">=</span> <span class="n">type_check</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>

<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run add 100000 times'</span><span class="p">)</span>


<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'base_add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import base_add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run base_add 100000 times'</span><span class="p">)</span>


<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'tc_add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import tc_add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run tc_add 100000 times'</span><span class="p">)</span>
</pre>


<p>Result:</p>
<pre class="code literal-block"><span></span><span class="c1">#it takes  0.013391613000000024  seconds to run add 100000 times</span>
<span class="c1">#it takes  0.029804532999999994  seconds to run base_add 100000 times</span>
<span class="c1">#it takes  0.708789169  seconds to run tc_add 100000 times</span>
</pre>


<p>Adding a function decorator add a little overhead while the type checker 
put huge overhead onto the original function. It is due to that the <code>bind_partial</code> method
dynamically analyses where <code>*args</code> and <code>**kwarg</code> would be mapped to the signature, in native python code, while the handling of
<code>*args</code> and <code>**kwarg</code> of an actual function call is optimized in c, now what if we can leverage that?</p>
<h4>The Hack</h4>
<pre class="code literal-block"><span></span><span class="n">fn_s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">def magic_func {0}:</span>
<span class="s2">    {1}</span>
<span class="s2">                """</span>

<span class="k">def</span> <span class="nf">type_check_fast</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">assert_str</span> <span class="o">=</span> <span class="s1">'assert '</span> <span class="o">+</span> <span class="s1">' and '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"isinstance({k},{v})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'compiling:</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">fn_s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">assert_str</span><span class="p">))</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">fn_s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">assert_str</span><span class="p">))</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">'magic_func'</span><span class="p">]</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">deced</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">deced</span>
</pre>


<p>Yes, <code>exec</code> is used here. The trick is to compile a function with signature that follows the target function's,
and construct assert statement dynamically, so that the string</p>
<pre class="code literal-block"><span></span><span class="n">fn_s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">def magic_func {0}:</span>
<span class="s2">    {1}</span>
<span class="s2">                """</span>
</pre>


<p>got formatted to:</p>
<pre class="code literal-block"><span></span><span class="c1">#def magic_func (a: int, b: int) -&gt; int:</span>
<span class="c1">#    assert isinstance(a,int) and isinstance(b,int)</span>
</pre>


<p>The string is then evaluated by the <code>exec</code> statement.</p>
<p>The new function defined in the local scope is then accessable with <code>locals()['magic_func']</code>.</p>
<p>Let's put it all together:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="n">fn_s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">def magic_func {0}:</span>
<span class="s2">    {1}</span>
<span class="s2">                """</span>

<span class="k">def</span> <span class="nf">type_check_fast</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">assert_str</span> <span class="o">=</span> <span class="s1">'assert '</span> <span class="o">+</span> <span class="s1">' and '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"isinstance({k},{v})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'compiling:</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">fn_s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">assert_str</span><span class="p">))</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">fn_s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">assert_str</span><span class="p">))</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">'magic_func'</span><span class="p">]</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">deced</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">deced</span>

<span class="k">def</span> <span class="nf">type_check</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">wrapped</span>

<span class="k">def</span> <span class="nf">useless_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">base_add</span> <span class="o">=</span> <span class="n">useless_wrapper</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="n">tc_add</span> <span class="o">=</span> <span class="n">type_check</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="n">fast_tc_add</span> <span class="o">=</span> <span class="n">type_check_fast</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>

<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run add 100000 times'</span><span class="p">)</span>


<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'base_add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import base_add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run base_add 100000 times'</span><span class="p">)</span>


<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'tc_add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import tc_add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run tc_add 100000 times'</span><span class="p">)</span>


<span class="n">t</span><span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="s1">'fast_tc_add(1,1)'</span><span class="p">,</span>
       <span class="n">setup</span><span class="o">=</span><span class="s1">'from __main__ import fast_tc_add'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'it takes '</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">' seconds to run fast_tc_add 100000 times'</span><span class="p">)</span>
</pre>


<p>Result:</p>
<pre class="code literal-block"><span></span><span class="c1">#compiling:</span>
<span class="c1"># </span>
<span class="c1">#def magic_func (a: int, b: int) -&gt; int:</span>
<span class="c1">#    assert isinstance(a,int) and isinstance(b,int)</span>
<span class="c1">#                </span>
<span class="c1">#it takes  0.013479943000000001  seconds to run add 100000 times</span>
<span class="c1">#it takes  0.030140912  seconds to run base_add 100000 times</span>
<span class="c1">#it takes  0.713209548  seconds to run tc_add 100000 times</span>
<span class="c1">#it takes  0.07377745000000002  seconds to run fast_tc_add 100000 times</span>
</pre>


<p>The new type checker is 100 times faster than the origional one. Given 
that adding a "useless" decorator (invoking one extra function) adds 0.017 second of overhead, 
we achieved 0.07 second with essentially two extra function invoked with <code>fast_tc_add</code>.</p>
<h4>Hack 2 - auto type check</h4>
<p>Adding a decorator to every function you have written is very, very ugly. What if we can:</p>
<ol>
<li>At the end of each module, access all variables declared in the local scope.</li>
<li>For all variables belongs to the "current" module and is function type:</li>
<li>Wrap those functions with the type_check decorator.</li>
</ol>
<p>Save the following as <code>tc.py</code>:</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="n">fn_s</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">def magic_func {0}:</span>
<span class="s2">    {1}</span>
<span class="s2">                """</span>

<span class="k">def</span> <span class="nf">type_check_fast</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'return'</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">assert_str</span> <span class="o">=</span> <span class="s1">'assert '</span> <span class="o">+</span> <span class="s1">' and '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"isinstance({k},{v})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">fn_s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">assert_str</span><span class="p">))</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">'magic_func'</span><span class="p">]</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">deced</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_type</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="n">return_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_value</span>
    <span class="k">return</span> <span class="n">deced</span>

<span class="k">def</span> <span class="nf">auto_dec</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">dic_locals</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dic_locals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s1">'__module__'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">dic_locals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_check_fast</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre>


<p>Then, in another <code>.py</code> file, put <code>auto_dec(__name__,locals())</code> after all function are decleared:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">tc</span> <span class="kn">import</span> <span class="n">auto_dec</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>

<span class="k">def</span> <span class="nf">otherfunc</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>

<span class="k">def</span> <span class="nf">otherotherfunc</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>

<span class="n">auto_dec</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">locals</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span> <span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">otherfunc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">otherotherfunc</span><span class="p">(</span><span class="s1">'nah'</span><span class="p">,</span><span class="s1">'got string'</span><span class="p">))</span>
</pre>


<p>Result:</p>
<pre class="code literal-block"><span></span><span class="mi">3</span>
<span class="mi">3</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>

  <span class="n">File</span> <span class="s2">"/Projects/aw/test.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">otherotherfunc</span><span class="p">(</span><span class="s1">'nah'</span><span class="p">,</span><span class="s1">'got string'</span><span class="p">))</span>
  <span class="n">File</span> <span class="s2">"/Projects/aw/tc.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">20</span><span class="p">,</span> <span class="ow">in</span> <span class="n">deced</span>
    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"&lt;string&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="p">,</span> <span class="ow">in</span> <span class="n">magic_func</span>
<span class="ne">AssertionError</span>
</pre>


<p>Source code of this post can be found <a href="https://github.com/fpim/type_checker">here</a>.</p>
</div>
        </div>
        </article>
</div>

               <script>var disqus_shortname="from-python-import-me";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
            </div>
        </div>
        <button class="btn btn-fab btn-raised btn-material-green btn-footer" data-toggle="modal" data-target="#footer-dialog">
            <i class="mdi-communication-message"></i>
        </button>
        <div id="footer-dialog" class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">from python import me credits</h4>
              </div>
              <div class="modal-body">
                    Contents © 2019         <a href="mailto:frompythonimportme@gmail.com">fyim</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                    
              </div>
              <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">Ok</button>
              </div>
            </div>
          </div>
        </div>
        <div class="source-button">
        </div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>

            $(document).ready(function() {
                // This command is used to initialize some elements and make them work properly
                $.material.init();
            });

            $(window).on("resize", function() {
                if($(window).width() > 767) {
                  $("html, body").height($(window).height());
                  $(".main, .menu").height($(window).height() - $(".header-panel").outerHeight() - 76 );
                  $(".posts-material").height($(window).height());
                } else {
                  $("html, body").css('height', '');
                  $(".main, .menu").css('height', '');
                  $(".posts-material").css('height', '');
                }
            }).trigger("resize");

            function menuToggle() {
                $("nav.menu, ul").toggleClass('responsive', '');
            }
        </script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
